<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SatoshiAds - App Real (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .satoshi-gradient { background: linear-gradient(90deg, #F7931A, #FFAD4A); }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Contenedor Principal de la App -->
    <div id="app-container" class="w-full max-w-md mx-auto min-h-screen flex flex-col justify-center p-4">

        <!-- Pantalla de Carga Inicial -->
        <div id="loading-screen" class="text-center">
            <h1 class="text-3xl font-bold satoshi-gradient text-transparent bg-clip-text">Satoshi<span class="font-light">Ads</span></h1>
            <p class="text-gray-400 mt-2">Conectando al servidor...</p>
        </div>

        <!-- Pantalla de Autenticaci√≥n (Login/Registro) -->
        <div id="auth-screen" class="hidden">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold satoshi-gradient text-transparent bg-clip-text">Satoshi<span class="font-light">Ads</span></h1>
                <p class="text-gray-300 mt-2">Gana Bitcoin viendo anuncios.</p>
            </div>
            <div class="bg-gray-800 p-8 rounded-xl shadow-lg">
                <h2 id="auth-title" class="text-xl font-bold text-center mb-6">Iniciar Sesi√≥n</h2>
                <form id="auth-form">
                    <div id="username-field" class="mb-4 hidden">
                        <label for="username" class="block text-sm font-medium text-gray-300 mb-2">Nombre de Usuario</label>
                        <input type="text" id="username" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-orange-500 focus:border-orange-500" placeholder="tu_usuario">
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-2">Correo Electr√≥nico</label>
                        <input type="email" id="email" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-orange-500 focus:border-orange-500" placeholder="tu@email.com">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Contrase√±a</label>
                        <input type="password" id="password" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-orange-500 focus:border-orange-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <p id="auth-error" class="text-red-400 text-center text-sm mb-4 hidden"></p>
                    <button type="submit" id="auth-submit-btn" class="w-full satoshi-gradient text-gray-900 font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity">
                        Entrar
                    </button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    <span id="auth-prompt-text">¬øNo tienes cuenta?</span>
                    <button id="auth-toggle-btn" class="font-semibold text-orange-400 hover:underline">Reg√≠strate aqu√≠</button>
                </p>
            </div>
        </div>

        <!-- Panel Principal del Usuario -->
        <div id="dashboard-screen" class="hidden w-full">
             <header class="flex justify-between items-center mb-6 pt-4">
                <h1 class="text-2xl font-bold satoshi-gradient text-transparent bg-clip-text">Satoshi<span class="font-light">Ads</span></h1>
                <div class="text-right">
                    <p id="user-display" class="text-sm text-gray-300 font-semibold truncate max-w-[150px]"></p>
                    <button id="logout-btn" class="text-xs text-orange-400 hover:underline">Cerrar Sesi√≥n</button>
                </div>
            </header>
            <div id="dashboard-content">
                <div class="satoshi-gradient p-6 rounded-xl shadow-lg mb-6 text-center text-gray-900">
                    <p class="text-lg font-medium opacity-80">Saldo Acumulado</p>
                    <h2 class="text-5xl font-bold tracking-tighter" id="balance">0</h2>
                    <p class="text-lg font-medium opacity-80">satoshis</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-6">
                    <div id="ad-placeholder" class="w-full h-40 bg-gray-700 rounded-lg flex items-center justify-center mb-4 text-center">
                        <p class="text-gray-400">¬°Listo para ver un anuncio!</p>
                    </div>
                    <button id="watch-ad-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">
                        üé¨ Ver Anuncio (Gana 1,000 satoshis)
                    </button>
                    <div id="timer-container" class="hidden text-center mt-4"><p class="text-sm text-gray-400">Viendo anuncio... <span id="timer" class="font-bold">3</span>s</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">Tu Direcci√≥n de Pago</h3>
                        <span id="wallet-status" class="text-xs text-gray-500"></span>
                    </div>
                    <p class="text-sm text-gray-400 mb-4">El pago se enviar√° aqu√≠ autom√°ticamente al llegar a <span id="payout-threshold-text">10,000</span> satoshis.</p>
                    <input type="text" id="btc-address" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-orange-500 focus:border-orange-500" placeholder="Introduce tu direcci√≥n de Bitcoin (bc1q...)">
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-4"><div id="progress-bar" class="bg-orange-500 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div></div>
                </div>
            </div>
            <div id="processing-panel" class="hidden text-center bg-gray-800 p-8 rounded-xl shadow-lg fade-in">
                <svg class="mx-auto h-12 w-12 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <h2 class="mt-4 text-2xl font-bold text-white">¬°Pago en Proceso!</h2>
                <p class="mt-2 text-gray-300">Has alcanzado el umbral. Tu solicitud se ha generado.</p>
                <div class="mt-6 text-left bg-gray-900 p-4 rounded-lg">
                    <p class="text-xs text-gray-500">Monto:</p><p id="payout-amount" class="text-white font-bold text-lg"></p>
                    <p class="text-xs text-gray-500 mt-2">Direcci√≥n de destino:</p><p id="payout-address" class="text-orange-400 text-sm break-words"></p>
                </div>
            </div>
            <footer class="text-center mt-6"><p class="text-xs text-gray-500">&copy; 2025 SatoshiAds. Todos los derechos reservados.</p></footer>
        </div>
    </div>

    <!-- SDK de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const SUPABASE_URL = 'https://xuvnvzymjntlqtbdmvnk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1dm52enltam50bHF0YmRtdm5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1MTI0ODYsImV4cCI6MjA2NzA4ODQ4Nn0.cfOVV53bsqB6spQ0sltdhzFLc5KQDDIJkBFRj5h8S-U';

        let supabase;
        try {
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch(e) {
            console.error("Error inicializando Supabase:", e);
            document.getElementById('loading-screen').innerHTML = `<p class="text-red-400">Error: No se pudo conectar con el servidor.</p>`;
            return;
        }

        // --- SELECTORES DEL DOM ---
        const screens = { loading: document.getElementById('loading-screen'), auth: document.getElementById('auth-screen'), dashboard: document.getElementById('dashboard-screen') };
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authPromptText = document.getElementById('auth-prompt-text');
        const authErrorEl = document.getElementById('auth-error');
        const usernameField = document.getElementById('username-field');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        const balanceEl = document.getElementById('balance');
        const watchAdBtn = document.getElementById('watch-ad-btn');
        const timerContainer = document.getElementById('timer-container');
        const timerEl = document.getElementById('timer');
        const adPlaceholder = document.getElementById('ad-placeholder');
        const btcAddressInput = document.getElementById('btc-address');
        const progressBar = document.getElementById('progress-bar');
        const payoutThresholdText = document.getElementById('payout-threshold-text');
        const dashboardContent = document.getElementById('dashboard-content');
        const processingPanel = document.getElementById('processing-panel');
        const payoutAmountEl = document.getElementById('payout-amount');
        const payoutAddressEl = document.getElementById('payout-address');
        const walletStatusEl = document.getElementById('wallet-status');

        // --- ESTADO Y CONFIGURACI√ìN DE LA APP ---
        let isLoginMode = true;
        let walletSaveTimeout = null;
        let currentUser = null;
        let profileSubscription = null;
        const PAYOUT_THRESHOLD = 10000;
        const AD_REWARD = 1000;
        const AD_VIEW_DURATION = 3;

        // --- L√ìGICA DE NAVEGACI√ìN ---
        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName]?.classList.remove('hidden');
            screens[screenName]?.classList.add('fade-in');
        }

        // --- L√ìGICA DE AUTENTICACI√ìN ---
        authToggleBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            authForm.reset();
            authErrorEl.classList.add('hidden');
            authTitle.textContent = isLoginMode ? 'Iniciar Sesi√≥n' : 'Crear Cuenta';
            authSubmitBtn.textContent = isLoginMode ? 'Entrar' : 'Registrarme';
            authPromptText.textContent = isLoginMode ? '¬øNo tienes cuenta?' : '¬øYa tienes cuenta?';
            authToggleBtn.textContent = isLoginMode ? 'Reg√≠strate aqu√≠' : 'Inicia sesi√≥n';
            usernameField.classList.toggle('hidden', isLoginMode);
            usernameInput.required = !isLoginMode;
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const username = usernameInput.value.trim();
            authErrorEl.classList.add('hidden');
            authSubmitBtn.disabled = true;

            try {
                if (isLoginMode) {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } else {
                    if (!username) throw { message: 'Por favor, introduce un nombre de usuario.' };
                    
                    // Verificar si el nombre de usuario ya existe
                    const { data: existingUser, error: checkError } = await supabase.from('profiles').select('username').eq('username', username).single();
                    if (existingUser) throw { message: 'El nombre de usuario ya est√° en uso.'};

                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                username: username,
                            }
                        }
                    });
                    if (error) throw error;
                    // El perfil se crear√° con un trigger en la base de datos o con la funci√≥n de escucha
                }
            } catch (error) {
                console.error("Auth Error:", error);
                authErrorEl.textContent = error.message;
                authErrorEl.classList.remove('hidden');
            } finally {
                authSubmitBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
        });

        // --- MANEJO DEL ESTADO DE SESI√ìN ---
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (profileSubscription) {
                profileSubscription.unsubscribe();
                profileSubscription = null;
            }
            
            const user = session?.user;
            currentUser = user;

            if (user) {
                await setupUserDashboard(user);
                showScreen('dashboard');
            } else {
                showScreen('auth');
            }
        });

        // --- L√ìGICA DEL PANEL DE USUARIO ---
        async function setupUserDashboard(user) {
            payoutThresholdText.textContent = PAYOUT_THRESHOLD.toLocaleString();
            
            // Escuchar cambios en el perfil en tiempo real
            profileSubscription = supabase
                .channel(`public:profiles:id=eq.${user.id}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles', filter: `id=eq.${user.id}` }, payload => {
                    updateDashboardUI(payload.new);
                })
                .subscribe();

            // Cargar datos iniciales
            const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            if (data) {
                updateDashboardUI(data);
            } else if (error) {
                console.error("Error fetching initial profile:", error);
            }
        }

        function updateDashboardUI(userData) {
            if (!userData) return;
            userDisplay.textContent = userData.username;
            if (userData.is_payment_pending) {
                dashboardContent.classList.add('hidden');
                payoutAmountEl.textContent = `${userData.balance.toLocaleString()} satoshis`;
                payoutAddressEl.textContent = userData.wallet_address;
                processingPanel.classList.remove('hidden');
            } else {
                dashboardContent.classList.remove('hidden');
                processingPanel.classList.add('hidden');
                balanceEl.textContent = userData.balance.toLocaleString();
                if (document.activeElement !== btcAddressInput) {
                    btcAddressInput.value = userData.wallet_address || '';
                }
                const progress = Math.min((userData.balance / PAYOUT_THRESHOLD) * 100, 100);
                progressBar.style.width = `${progress}%`;
            }
        }
        
        // --- L√ìGICA DE LA APP ---
        watchAdBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            watchAdBtn.disabled = true;
            adPlaceholder.innerHTML = `<p class="text-orange-400 animate-pulse">Visualizaci√≥n en progreso...</p>`;
            timerContainer.classList.remove('hidden');
            let timeLeft = AD_VIEW_DURATION;
            timerEl.textContent = timeLeft;

            const adInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(adInterval);
                    completeAdView();
                }
            }, 1000);
        });

        async function completeAdView() {
            const { data: currentProfile } = await supabase.from('profiles').select('balance, wallet_address').eq('id', currentUser.id).single();
            const newBalance = (currentProfile.balance || 0) + AD_REWARD;

            const { error } = await supabase.from('profiles').update({ balance: newBalance }).eq('id', currentUser.id);
            if (error) console.error("Error updating balance:", error);

            if (newBalance >= PAYOUT_THRESHOLD && currentProfile.wallet_address) {
                await triggerAutoPayout(newBalance, currentProfile.wallet_address);
            }

            watchAdBtn.disabled = false;
            timerContainer.classList.add('hidden');
            adPlaceholder.innerHTML = `<p class="text-green-400">¬°+${AD_REWARD.toLocaleString()} satoshis ganados!</p>`;
            setTimeout(() => adPlaceholder.innerHTML = `<p class="text-gray-400">¬°Listo para ver otro anuncio!</p>`, 2000);
        }
        
        btcAddressInput.addEventListener('input', () => {
            clearTimeout(walletSaveTimeout);
            walletStatusEl.textContent = 'Escribiendo...';
            walletStatusEl.className = 'text-xs text-yellow-400';
            walletSaveTimeout = setTimeout(async () => {
                const newAddress = btcAddressInput.value;
                const btcRegex = /^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,39}$/;
                if (newAddress && !btcRegex.test(newAddress)) {
                    walletStatusEl.textContent = 'Direcci√≥n inv√°lida';
                    walletStatusEl.className = 'text-xs text-red-400';
                    return;
                }
                walletStatusEl.textContent = 'Guardando...';
                const { error } = await supabase.from('profiles').update({ wallet_address: newAddress }).eq('id', currentUser.id);
                if (!error) {
                    walletStatusEl.textContent = 'Guardado';
                    walletStatusEl.className = 'text-xs text-green-400';
                } else {
                     walletStatusEl.textContent = 'Error al guardar';
                     walletStatusEl.className = 'text-xs text-red-400';
                }
            }, 1000);
        });

        async function triggerAutoPayout(balance, walletAddress) {
             const { data: profile } = await supabase.from('profiles').select('username, email').eq('id', currentUser.id).single();
             
             await supabase.from('profiles').update({ is_payment_pending: true }).eq('id', currentUser.id);
             await supabase.from('payouts').insert({
                 id: currentUser.id,
                 user_id: currentUser.id,
                 username: profile.username,
                 email: profile.email,
                 amount: balance,
                 wallet_address: walletAddress,
                 status: "pending"
             });
        }
    });
    </script>
</body>
</html>

